<!DOCTYPE html>
<html>
    <head>
        <title>Calendar Generator</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
		<style>
			/* Global styles */
			* {
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				line-height: 1.6;
				margin: 0;
				padding: 20px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				color: #333;
			}

			h1 {
				text-align: center;
				color: white;
				font-size: 2.5em;
				margin-bottom: 30px;
				text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			}

			h2 {
				color: #2c3e50;
				border-bottom: 3px solid #3498db;
				padding-bottom: 10px;
				margin-top: 30px;
			}

			/* Form container */
			form {
				background: white;
				padding: 30px;
				border-radius: 15px;
				box-shadow: 0 10px 30px rgba(0,0,0,0.2);
				max-width: 800px;
				margin: 0 auto 30px auto;
			}

			/* Form labels */
			label {
				display: block;
				margin-bottom: 8px;
				font-weight: 600;
				color: #2c3e50;
				font-size: 16px;
			}

			/* Form inputs */
			input[type="text"], 
			input[type="date"], 
			input[type="number"] {
				width: 100%;
				padding: 12px;
				border: 2px solid #ddd;
				border-radius: 8px;
				font-size: 16px;
				margin-bottom: 20px;
				transition: border-color 0.3s ease, box-shadow 0.3s ease;
			}

			input[type="text"]:focus, 
			input[type="date"]:focus, 
			input[type="number"]:focus {
				outline: none;
				border-color: #3498db;
				box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
			}

			/* Submit button */
			input[type="submit"] {
				background: linear-gradient(135deg, #3498db, #2980b9);
				color: white;
				padding: 15px 30px;
				border: none;
				border-radius: 8px;
				font-size: 18px;
				font-weight: 600;
				cursor: pointer;
				width: 100%;
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}

			input[type="submit"]:hover {
				transform: translateY(-2px);
				box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
			}

			/* Clear data button */
			#clear-data {
				background: linear-gradient(135deg, #95a5a6, #7f8c8d);
				color: white;
				padding: 15px 25px;
				border: none;
				border-radius: 8px;
				font-size: 16px;
				font-weight: 600;
				cursor: pointer;
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}

			#clear-data:hover {
				transform: translateY(-2px);
				box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
			}

			/* Content containers */
			#results-container {
				max-width: 800px;
				margin: 0 auto;
			}

			#summary, #calendar {
				background: white;
				padding: 30px;
				border-radius: 15px;
				box-shadow: 0 10px 30px rgba(0,0,0,0.2);
				margin: 30px 0;
			}

			/* Screenshot section */
			#screenshot-section {
				text-align: center;
				margin: 20px 0;
			}

			#capture-btn {
				background: linear-gradient(135deg, #9b59b6, #8e44ad);
				color: white;
				border: none;
				padding: 15px 30px;
				border-radius: 8px;
				font-size: 16px;
				font-weight: 600;
				cursor: pointer;
				transition: transform 0.2s ease, box-shadow 0.2s ease;
				margin: 10px;
			}

			#capture-btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
			}

			/* Table styles */
			table { 
				width: 100%; 
				border-collapse: collapse; 
				margin: 20px 0;
				background: white;
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			}

			/* Zebra striping */
			tr:nth-of-type(odd) { 
				background: #f8f9fa; 
			}

			th { 
				background: linear-gradient(135deg, #3498db, #2980b9);
				color: white; 
				font-weight: 600; 
			}

			td, th { 
				padding: 15px; 
				border: none;
				text-align: left; 
				font-size: 16px;
			}

			tr:hover {
				background: #e8f4fd;
				transition: background-color 0.2s ease;
			}

			/* Spending items styling */
			#spending-items {
				margin: 20px 0;
			}

			.spending-item {
				display: flex;
				align-items: center;
				gap: 15px;
				margin: 15px 0;
				padding: 20px;
				border: 2px solid #ecf0f1;
				border-radius: 12px;
				background: #f8f9fa;
				transition: border-color 0.3s ease, transform 0.2s ease;
			}

			.spending-item:hover {
				border-color: #3498db;
				transform: translateY(-2px);
			}

			.spending-item input {
				margin: 0;
				margin-bottom: 0 !important;
			}

			.item-name {
				flex: 2;
				min-width: 200px;
			}

			.item-price {
				flex: 1;
				min-width: 120px;
			}

			.remove-item {
				background: linear-gradient(135deg, #e74c3c, #c0392b);
				color: white;
				border: none;
				padding: 12px 20px;
				border-radius: 8px;
				cursor: pointer;
				font-weight: 600;
				transition: transform 0.2s ease, box-shadow 0.2s ease;
				white-space: nowrap;
			}

			.remove-item:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
			}

			/* Spending controls container */
			#spending-controls {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin: 20px 0;
			}

			#add-item {
				background: linear-gradient(135deg, #27ae60, #229954);
				color: white;
				border: none;
				padding: 15px 25px;
				border-radius: 8px;
				cursor: pointer;
				font-size: 16px;
				font-weight: 600;
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}

			#add-item:hover {
				transform: translateY(-2px);
				box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
			}

			#total-display {
				font-weight: 600;
				font-size: 20px;
				color: #2c3e50;
				background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
				padding: 15px 20px;
				border-radius: 8px;
				text-align: center;
				margin: 20px 0;
				border: 2px solid #95a5a6;
			}

			/* Responsive design for spending items */
			@media (max-width: 768px) {
				.spending-item {
					flex-direction: column;
					align-items: stretch;
				}
				
				.item-name, .item-price {
					min-width: unset;
				}
			}
		</style>
    </head>
    <body>
        <h1>Calendar Generator</h1>
        <form method="get" action="#" id="calendar-form">
            <label for="start-date">Start Date:</label>
            <input type="date" id="start-date" name="start-date"><br>
            <label for="num-days">Number of Days:</label>
            <input type="number" id="num-days" name="num-days"><br>
			<label for="names">Names (separated by comma):</label>
			<input type="text" id="names" name="names"><br>
			
			<label>Spending Items:</label>
			<div id="spending-items">
				<div class="spending-item">
					<input type="text" class="item-name" placeholder="Item name" required>
					<input type="number" class="item-price" placeholder="Price" step="0.01" required>
					<button type="button" class="remove-item" onclick="removeSpendingItem(this)">Remove</button>
				</div>
			</div>
			<div id="spending-controls">
				<button type="button" id="add-item" onclick="addSpendingItem()">Add Item</button>
				<button type="button" id="clear-data" onclick="clearSavedData()">Clear Saved Data</button>
			</div><br>
			
			<div id="total-display">Total Cost: $0.00</div><br>
            <input type="submit" value="Generate Calendar">
        </form>
		<div id="results-container" style="display: none;">
			<div id="summary"></div>
			<div id="calendar"></div>
			<div id="screenshot-section" style="display: none;">
				<button id="capture-btn" onclick="captureScreenshot()">📸 Capture & Download Image</button>
			</div>
		</div>
        <script>
			// Get form and calendar elements
			const form = document.getElementById('calendar-form');
			const calendar = document.getElementById('calendar');
			const summary = document.getElementById('summary');

			// Function to add new spending item
			function addSpendingItem() {
				const spendingItems = document.getElementById('spending-items');
				const newItem = document.createElement('div');
				newItem.className = 'spending-item';
				newItem.innerHTML = `
					<input type="text" class="item-name" placeholder="Item name" required>
					<input type="number" class="item-price" placeholder="Price" step="0.01" required>
					<button type="button" class="remove-item" onclick="removeSpendingItem(this)">Remove</button>
				`;
				spendingItems.appendChild(newItem);
				
				// Add event listener to new price input
				const priceInput = newItem.querySelector('.item-price');
				priceInput.addEventListener('input', updateTotal);
			}

			// Function to remove spending item
			function removeSpendingItem(button) {
				const spendingItems = document.getElementById('spending-items');
				const items = spendingItems.querySelectorAll('.spending-item');
				
				// Only allow removal if more than one item exists
				if (items.length > 1) {
					button.parentElement.remove();
					updateTotal();
				} else {
					alert('At least one item is required.');
				}
			}

			// Function to calculate and update total cost
			function updateTotal() {
				const priceInputs = document.querySelectorAll('.item-price');
				let total = 0;
				
				priceInputs.forEach(input => {
					const value = parseFloat(input.value) || 0;
					total += value;
				});
				
				document.getElementById('total-display').textContent = `Total Cost: $${total.toFixed(2)}`;
				return total;
			}

			// Function to save form data to localStorage
			function saveFormData() {
				const formData = {
					startDate: document.getElementById('start-date').value,
					numDays: document.getElementById('num-days').value,
					names: document.getElementById('names').value,
					spendingItems: []
				};
				
				// Collect all spending items
				const spendingItems = document.querySelectorAll('.spending-item');
				spendingItems.forEach(item => {
					const itemName = item.querySelector('.item-name').value;
					const itemPrice = item.querySelector('.item-price').value;
					if (itemName || itemPrice) { // Only save if there's some data
						formData.spendingItems.push({
							name: itemName,
							price: itemPrice
						});
					}
				});
				
				localStorage.setItem('calendarGeneratorData', JSON.stringify(formData));
				console.log('Form data saved to localStorage');
			}

			// Function to load form data from localStorage
			function loadFormData() {
				const savedData = localStorage.getItem('calendarGeneratorData');
				if (savedData) {
					try {
						const formData = JSON.parse(savedData);
						
						// Load basic form fields
						document.getElementById('start-date').value = formData.startDate || '';
						document.getElementById('num-days').value = formData.numDays || '';
						document.getElementById('names').value = formData.names || '';
						
						// Load spending items
						if (formData.spendingItems && formData.spendingItems.length > 0) {
							// Clear existing spending items first
							const spendingContainer = document.getElementById('spending-items');
							spendingContainer.innerHTML = '';
							
							// Add each saved spending item
							formData.spendingItems.forEach((item, index) => {
								const spendingItem = document.createElement('div');
								spendingItem.className = 'spending-item';
								spendingItem.innerHTML = `
									<input type="text" class="item-name" placeholder="Item name" value="${item.name}" required>
									<input type="number" class="item-price" placeholder="Price" step="0.01" value="${item.price}" required>
									<button type="button" class="remove-item" onclick="removeSpendingItem(this)">Remove</button>
								`;
								spendingContainer.appendChild(spendingItem);
								
								// Add event listener to price input
								const priceInput = spendingItem.querySelector('.item-price');
								priceInput.addEventListener('input', updateTotal);
							});
							
							// Update total after loading
							updateTotal();
						}
						
						console.log('Form data loaded from localStorage');
					} catch (error) {
						console.error('Error loading saved data:', error);
					}
				}
			}

			// Function to clear saved data
			function clearSavedData() {
				if (confirm('Are you sure you want to clear all saved data? This will reset the form.')) {
					localStorage.removeItem('calendarGeneratorData');
					
					// Reset form
					document.getElementById('start-date').value = '';
					document.getElementById('num-days').value = '';
					document.getElementById('names').value = '';
					
					// Reset spending items to just one empty item
					const spendingContainer = document.getElementById('spending-items');
					spendingContainer.innerHTML = `
						<div class="spending-item">
							<input type="text" class="item-name" placeholder="Item name" required>
							<input type="number" class="item-price" placeholder="Price" step="0.01" required>
							<button type="button" class="remove-item" onclick="removeSpendingItem(this)">Remove</button>
						</div>
					`;
					
					// Re-add event listener to the price input
					const priceInput = spendingContainer.querySelector('.item-price');
					priceInput.addEventListener('input', updateTotal);
					
					updateTotal();
					
					// Clear results and hide container
					document.getElementById('summary').innerHTML = '';
					document.getElementById('calendar').innerHTML = '';
					document.getElementById('results-container').style.display = 'none';
					document.getElementById('screenshot-section').style.display = 'none';
					
					alert('Saved data cleared successfully!');
				}
			}

			// Add event listeners to existing price inputs on page load
			document.addEventListener('DOMContentLoaded', function() {
				// Load saved data first
				loadFormData();
				
				// Then add event listeners to any existing price inputs
				const priceInputs = document.querySelectorAll('.item-price');
				priceInputs.forEach(input => {
					input.addEventListener('input', updateTotal);
				});
			});

			// Add submit event listener to form
			form.addEventListener('submit', function(e) {
			    e.preventDefault(); // prevent form from submitting

			    // Get start date and number of days inputs
			    const startDateInput = document.getElementById('start-date');
			    const numDaysInput = document.getElementById('num-days');
				const names = document.getElementById('names').value.split(",");
				const totalCost = updateTotal(); // Get total from spending items
				
				// Save form data to localStorage
				saveFormData();
				let nameDict = {}
				for (const name of names) {
					nameDict[name] = 0;
				}

			    // Parse input values
			    const startDate = new Date(startDateInput.value);
			    const numDays = parseInt(numDaysInput.value);

			    // Calculate end date
			    const endDate = new Date(startDate.getTime() + (numDays) * 24 * 60 * 60 * 1000);

			    // Generate calendar
			    const calendarHtml = generateCalendarHtml(startDate, endDate, names, nameDict);
			    calendar.innerHTML = calendarHtml;
				
				// Generate summary
				const summaryHtml = generateSummary(nameDict, totalCost);
				summary.innerHTML = summaryHtml;
				
				// Show results container and screenshot button
				document.getElementById('results-container').style.display = 'block';
				document.getElementById('screenshot-section').style.display = 'block';
				
				console.log(nameDict);
			});
			
			// Function to generate summary
			function generateSummary(nameDict, totalCost) {
				let sum = 0;
				
				for (const key in nameDict) {
					if (nameDict.hasOwnProperty(key)) {
						sum += nameDict[key];
					}
				}
				
				// Generate spending items breakdown
				let summaryHtml = '<h2>Spending Items</h2><table><thead><tr><th>Item</th><th>Price</th></tr></thead><tbody>';
				const spendingItems = document.querySelectorAll('.spending-item');
				spendingItems.forEach(item => {
					const itemName = item.querySelector('.item-name').value || 'Unnamed Item';
					const itemPrice = parseFloat(item.querySelector('.item-price').value) || 0;
					summaryHtml += `<tr><td>${itemName}</td><td>$${itemPrice.toFixed(2)}</td></tr>`;
				});
				summaryHtml += `<tr style="font-weight: bold; background: #3498db; color: white;"><td>Total</td><td>$${totalCost.toFixed(2)}</td></tr>`;
				summaryHtml += '</tbody></table><br>';
				
				// Generate cost breakdown by person
				summaryHtml += '<h2>Cost Breakdown by Person</h2><table><thead><tr><th>Name</th><th>Days</th><th>Cost</th></tr></thead><tbody>'
				for (const name in nameDict) {
					if (nameDict.hasOwnProperty(name)) {
						let cost = (nameDict[name] / sum) * totalCost;
						cost = (Math.round(cost * 100) / 100).toFixed(2);
						summaryHtml += `<tr><td>${name}</td><td>${nameDict[name]}</td><td>$${cost}</td></tr>`;
					}
				}
				
				summaryHtml += '</tbody></table>';
				return summaryHtml;
			}

			// Function to generate calendar HTML
			function generateCalendarHtml(startDate, endDate, names, nameDict) {
				console.log("startDate:" + startDate);
				console.log("endDate:" + endDate);
			    let calendarHtml = '';
				let isFirstMonth = true;
				let isLastMonth = false;
				let nameIdx = 0;
				
			    // Loop through each month
			    for (let date = new Date(startDate.getFullYear(), startDate.getMonth(), 1); date <= endDate; date.setMonth(date.getMonth() + 1)) {
					console.log("processing Month:" + date);
					console.log("is date <= endDate?" + date <= endDate);
					if(new Date(date.getFullYear(), date.getMonth() + 1, 1) > endDate) {
						isLastMonth = true;
					}
				
			        // Get month and year
			        const month = date.toLocaleString('default', {
			            month: 'long'
			        });
			        const year = date.getFullYear();

			        // Generate month header
			        calendarHtml += `<h2>${month} ${year}</h2>`;

			        // Generate table header
			        calendarHtml += '<table><thead><tr>';
			        calendarHtml += '<th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>';
			        calendarHtml += '</tr></thead><tbody>';

			        // Get first day of the month
			        const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);

			        // Generate table rows
					let dayOfMonth = startDate.getDate()+1;
					let firstDayOfMonthIndex = (startDate.getDay() + 1) % 7;
					if(!isFirstMonth) {
						dayOfMonth = 1;
						firstDayOfMonthIndex = firstDayOfMonth.getDay();
					}
					let lastDayOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
					if(isLastMonth) {
						lastDayOfMonth = endDate.getDate();
					}
			        while (dayOfMonth <= lastDayOfMonth) {
			            calendarHtml += '<tr>';

			            // Generate cells for each day of the week
			            for (let i = 0; i < 7; i++) {
							// if firstMonth, then need to skip the first few days if the first day is not sunday
							if (isFirstMonth && i < firstDayOfMonthIndex) {
								calendarHtml += '<td></td>';
							} else if ((i >= firstDayOfMonthIndex || dayOfMonth > 1) && dayOfMonth <= lastDayOfMonth) {
								isFirstMonth = false;
								let currentName = names[nameIdx];
								calendarHtml += `<td>${dayOfMonth}<br>${currentName}</td>`;
								dayOfMonth++;
								nameDict[names[nameIdx]] = nameDict[names[nameIdx]] + 1;
								nameIdx = (nameIdx + 1) % (names.length);
			                } else {
			                    calendarHtml += '<td></td>';
			                }
			            }

			            calendarHtml += '</tr>';
			        }

			        calendarHtml += '</tbody></table>';
			    }

			    return calendarHtml;
			}

			// Function to capture screenshot of the results
			async function captureScreenshot() {
				const captureBtn = document.getElementById('capture-btn');
				const originalText = captureBtn.innerHTML;
				
				// Show loading state
				captureBtn.innerHTML = '📸 Capturing...';
				captureBtn.disabled = true;
				
				try {
					// Create a container that includes both summary and calendar
					const summary = document.getElementById('summary');
					const calendar = document.getElementById('calendar');
					
					// Create a temporary container for screenshot
					const tempContainer = document.createElement('div');
					tempContainer.style.background = 'white';
					tempContainer.style.padding = '20px';
					tempContainer.style.borderRadius = '15px';
					tempContainer.style.position = 'absolute';
					tempContainer.style.left = '-9999px';
					tempContainer.style.top = '0';
					tempContainer.style.width = '800px';
					
					// Clone the summary and calendar content
					const summaryClone = summary.cloneNode(true);
					const calendarClone = calendar.cloneNode(true);
					
					tempContainer.appendChild(summaryClone);
					tempContainer.appendChild(calendarClone);
					document.body.appendChild(tempContainer);
					
					// Capture the screenshot
					const canvas = await html2canvas(tempContainer, {
						backgroundColor: '#ffffff',
						scale: 2, // Higher quality
						useCORS: true,
						allowTaint: true,
						width: 800,
						scrollX: 0,
						scrollY: 0
					});
					
					// Remove temporary container
					document.body.removeChild(tempContainer);
					
					// Create download link
					const link = document.createElement('a');
					link.download = `calendar-sharing-${new Date().toISOString().split('T')[0]}.png`;
					link.href = canvas.toDataURL();
					
					// Trigger download
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
					
					// Show success message
					captureBtn.innerHTML = '✅ Downloaded!';
					setTimeout(() => {
						captureBtn.innerHTML = originalText;
						captureBtn.disabled = false;
					}, 2000);
					
				} catch (error) {
					console.error('Error capturing screenshot:', error);
					captureBtn.innerHTML = '❌ Error occurred';
					setTimeout(() => {
						captureBtn.innerHTML = originalText;
						captureBtn.disabled = false;
					}, 2000);
				}
			}
		</script>
    </body>
</html>